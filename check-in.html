<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest Check-In - Toosonj Guest House</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for modern typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- React & ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel Standalone for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body>
    <div id="root">
        <!-- React app will be mounted here -->
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Mock Component Imports (for standalone demonstration) ---
        // These replace shadcn/ui and lucide-react components for direct browser execution.
        // In a real build environment, these would be proper imports.
        const Button = ({ children, className = '', ...props }) => <button className={`inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-gray-900 text-gray-50 hover:bg-gray-900/90 h-10 px-4 py-2 ${className}`} {...props}>{children}</button>;
        const Input = ({ className = '', type = 'text', ...props }) => <input type={type} className={`flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 ${className}`} {...props} />;
        const Label = ({ children, className = '', ...props }) => <label className={`text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 ${className}`} {...props}>{children}</label>;
        const Select = ({ children, value, onValueChange }) => {
            const handleChange = (e) => onValueChange(e.target.value);
            return (
                <select value={value} onChange={handleChange} className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    {children}
                </select>
            );
        };
        const SelectTrigger = ({ children, className = '' }) => <div className={`flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 ${className}`}>{children}</div>;
        const SelectValue = ({ placeholder }) => <span>{placeholder}</span>;
        const SelectContent = ({ children }) => <div className="relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2">{children}</div>;
        const SelectItem = ({ children, value }) => <option value={value} className="relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50">{children}</option>;
        const Checkbox = ({ checked, onCheckedChange, className = '', ...props }) => (
            <input
                type="checkbox"
                checked={checked}
                onChange={(e) => onCheckedChange(e.target.checked)}
                className={`peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground ${className}`}
                {...props}
            />
        );
        const Card = ({ children, className = '', ...props }) => <div className={`rounded-xl border bg-card text-card-foreground shadow ${className}`} {...props}>{children}</div>;
        const CardHeader = ({ children, className = '', ...props }) => <div className={`flex flex-col space-y-1.5 p-6 ${className}`} {...props}>{children}</div>;
        const CardTitle = ({ children, className = '', ...props }) => <h3 className={`text-2xl font-semibold leading-none tracking-tight ${className}`} {...props}>{children}</h3>;
        const CardDescription = ({ children, className = '', ...props }) => <p className={`text-sm text-muted-foreground ${className}`} {...props}>{children}</p>;
        const CardContent = ({ children, className = '', ...props }) => <div className={`p-6 pt-0 ${className}`} {...props}>{children}</div>;
        const CardFooter = ({ children, className = '', ...props }) => <div className={`flex items-center p-6 pt-0 ${className}`} {...props}>{children}</div>;
        
        // Basic Dialog mock
        const Dialog = ({ children }) => <div>{children}</div>;
        const DialogTrigger = ({ children, asChild }) => asChild ? children : <div>{children}</div>;
        const DialogContent = ({ children }) => <div className="fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4"><div className="relative z-50 w-full max-w-lg rounded-lg border bg-background p-6 shadow-lg animate-fade-in">{children}</div></div>;
        const DialogHeader = ({ children }) => <div className="flex flex-col space-y-1.5 text-center sm:text-left">{children}</div>;
        const DialogTitle = ({ children }) => <h2 className="text-lg font-semibold leading-none tracking-tight">{children}</h2>;
        const DialogDescription = ({ children }) => <p className="text-sm text-muted-foreground">{children}</p>;

        const Alert = ({ children, variant = 'default', className = '', ...props }) => {
            const baseClasses = "relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&:has(svg)]:pl-10";
            const variantClasses = {
                default: "bg-background text-foreground",
                destructive: "border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive",
            };
            return <div className={`${baseClasses} ${variantClasses[variant]} ${className}`} {...props}>{children}</div>;
        };
        const AlertDescription = ({ children }) => <div className="text-sm [&_p]:leading-relaxed">{children}</div>;
        const AlertTitle = ({ children }) => <h5 className="mb-1 font-medium leading-none tracking-tight">{children}</h5>;

        // Lucide-React Icons Mock - using inline SVGs or simple text for demonstration
        const CalendarIcon = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>;
        const Upload = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const CheckCircle = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-8.94"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const AlertCircle = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const Loader2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const User = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>;
        const Mail = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.73a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>;
        const Phone = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.65A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-1.18 2.19l-.7.35a18.78 18.78 0 0 0 6.14 6.14l.35-.7a2 2 0 0 1 2.19-1.18 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>;
        const MapPin = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"/><circle cx="12" cy="10" r="3"/></svg>;
        const Building = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>;
        const Globe = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>;
        const Star = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;


        // --- CONSTANTS ---
        const API_BASE_URL = 'http://localhost:3000'; // Ensure this matches your backend server URL

        const STEPS = {
            BOOKING_ID: 1,
            FORM_FILL: 2,
            CONFIRMATION: 3,
            SUCCESS: 4,
        };

        const RELATIONSHIP_OPTIONS = [
            { value: 'family', label: 'Family' },
            { value: 'friends', label: 'Friends' },
            { value: 'colleagues', label: 'Colleagues' },
            { value: 'other', label: 'Other' }
        ];

        const ID_CARD_TYPES = [
            { value: 'passport', label: 'Passport' },
            { value: 'drivers_license', label: "Driver's License" },
            { value: 'national_id', label: 'National ID' },
            { value: 'other', label: 'Other' }
        ];

        // --- MAIN COMPONENT ---
        function App() { // Renamed from EnhancedCheckInForm to App
            // --- STATE MANAGEMENT ---
            const [currentStep, setCurrentStep] = useState(STEPS.BOOKING_ID);
            const [bookingId, setBookingId] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [errors, setErrors] = useState({});
            
            const [formData, setFormData] = useState({
                // Booking Details (pre-filled from backend)
                guestName: '',
                checkInDate: '',
                checkOutDate: '',
                
                // Form Fields
                numberOfGuests: '1',
                relationshipWithGuests: '',
                
                // Address
                city: '',
                nationality: '',
                state: '',
                zipCode: '',

                // ID
                idCardType: '',
                idCardTypeOther: '',
                idFile: null, // Stores file metadata: { name, type, size }
                
                // Emergency Contact (Optional)
                emergencyContactName: '',
                emergencyContactEmail: '',
                emergencyContactPhone: '',
                
                // Agreement
                termsAgreed: false
            });

            // --- API FUNCTIONS ---

            /**
             * Fetches booking details from the backend.
             * @param {string} id - The booking ID.
             * @returns {Promise<object>} A promise that resolves with booking data.
             */
            const fetchBookingDetailsAPI = async (id) => {
                console.log(`Fetching details for Booking ID: ${id} from backend...`);
                const response = await fetch(`${API_BASE_URL}/api/bookings/${id}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch booking details.');
                }
                const data = await response.json();
                // Adapt the backend response to match formData structure
                return {
                    success: true,
                    data: {
                        guestName: data.guest.name, // Assuming guest.name exists
                        checkInDate: data.checkinDate,
                        checkOutDate: data.checkoutDate,
                        // Pre-fill other fields if available in booking data
                        numberOfGuests: data.guest.numberOfGuests || '1',
                        relationshipWithGuests: data.guest.relationshipWithGuests || '',
                        city: data.guest.city || '',
                        nationality: data.guest.nationality || '',
                        state: data.guest.state || '',
                        zipCode: data.guest.pincode || '', // Assuming pincode is zipCode
                        idCardType: data.guest.idCardType || '',
                        idCardTypeOther: data.guest.idCardTypeOther || '',
                        emergencyContactName: data.guest.emergencyContactName || '',
                        emergencyContactEmail: data.guest.emergencyContactEmail || '',
                        emergencyContactPhone: data.guest.emergencyContactPhone || '',
                        termsAgreed: data.termsAgreed || false,
                    }
                };
            };
            
            /**
             * Submits the final form data to the backend.
             * @param {object} finalData - The form data to submit.
             * @returns {Promise<object>} A promise that resolves on successful submission.
             */
            const submitCheckInAPI = async (finalData) => {
                console.log("Submitting form data to backend...", finalData);
                const response = await fetch(`${API_BASE_URL}/api/bookings/${finalData.bookingId}/checkin`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(finalData),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to submit check-in form.');
                }
                return { success: true, message: 'Check-in successful!' };
            };

            // --- EVENT HANDLERS ---

            const handleBookingIdSubmit = async (e) => {
                e.preventDefault();
                if (!bookingId) {
                    setErrors({ bookingId: 'Booking ID is required.' });
                    return;
                }
                setIsLoading(true);
                setErrors({});
                try {
                    const response = await fetchBookingDetailsAPI(bookingId);
                    if (response.success) {
                        setFormData(prev => ({
                            ...prev,
                            ...response.data, // Merge all pre-filled data
                        }));
                        setCurrentStep(STEPS.FORM_FILL);
                    }
                } catch (error) {
                    setErrors({ bookingId: error.message || 'Failed to fetch booking details.' });
                } finally {
                    setIsLoading(false);
                }
            };
            
            const handleInputChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
                // Clear error for the field being edited
                if (errors[name]) {
                    setErrors(prev => {
                        const newErrors = { ...prev };
                        delete newErrors[name];
                        return newErrors;
                    });
                }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    // Store only necessary file metadata to send as JSON
                    handleInputChange('idFile', {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                    });
                } else {
                    handleInputChange('idFile', null);
                }
            };

            const handleFormSubmit = (e) => {
                e.preventDefault();
                if (validateForm()) {
                    setCurrentStep(STEPS.CONFIRMATION);
                }
            };
            
            const handleFinalSubmit = async () => {
                setIsSubmitting(true);
                setErrors({});
                
                // Prepare data for submission, including the bookingId
                const dataToSubmit = {
                    ...formData,
                    bookingId: bookingId, // Add bookingId to the payload
                };
                
                try {
                    const result = await submitCheckInAPI(dataToSubmit);
                    if (result.success) {
                        setCurrentStep(STEPS.SUCCESS);
                    }
                } catch (error) {
                    setErrors({ submit: error.message || 'An unexpected error occurred. Please try again.' });
                    setCurrentStep(STEPS.FORM_FILL); // Go back to form to show error
                } finally {
                    setIsSubmitting(false);
                }
            };
            
            const resetForm = () => {
                setBookingId('');
                setFormData({
                    guestName: '', checkInDate: '', checkOutDate: '', numberOfGuests: '1',
                    relationshipWithGuests: '', city: '', nationality: '', state: '',
                    zipCode: '', idCardType: '', idCardTypeOther: '', idFile: null,
                    emergencyContactName: '', emergencyContactEmail: '', emergencyContactPhone: '',
                    termsAgreed: false
                });
                setErrors({});
                setCurrentStep(STEPS.BOOKING_ID);
            };


            // --- VALIDATION ---
            const validateForm = () => {
                const newErrors = {};
                
                // Dates
                if (!formData.checkInDate) newErrors.checkInDate = 'Check-in date is required.';
                if (!formData.checkOutDate) newErrors.checkOutDate = 'Check-out date is required.';
                else if (new Date(formData.checkOutDate) <= new Date(formData.checkInDate)) {
                    newErrors.checkOutDate = 'Check-out date must be after check-in date.';
                }

                // Guests
                const numGuests = parseInt(formData.numberOfGuests);
                if (!formData.numberOfGuests) newErrors.numberOfGuests = 'Number of guests is required.';
                else if (isNaN(numGuests) || numGuests < 1 || numGuests > 10) {
                    newErrors.numberOfGuests = 'Guests must be between 1 and 10.';
                }
                if (numGuests > 1 && !formData.relationshipWithGuests) {
                    newErrors.relationshipWithGuests = 'Relationship is required for multiple guests.';
                }

                // Address
                if (!formData.city.trim()) newErrors.city = 'City / Locality is required.';
                if (!formData.nationality.trim()) newErrors.nationality = 'Nationality is required.';
                if (!formData.state.trim()) newErrors.state = 'State is required.';
                if (!/^\d{6}$/.test(formData.zipCode)) newErrors.zipCode = 'A valid 6-digit zip code is required.';

                // ID
                if (!formData.idCardType) newErrors.idCardType = 'ID card type is required.';
                if (formData.idCardType === 'other' && !formData.idCardTypeOther.trim()) {
                    newErrors.idCardTypeOther = 'Please specify the ID card type.';
                }
                if (!formData.idFile) {
                    newErrors.idFile = 'ID document upload is required.';
                } else {
                    const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
                    const maxSize = 5 * 1024 * 1024; // 5MB
                    if (!allowedTypes.includes(formData.idFile.type)) {
                        newErrors.idFile = 'File must be JPG, PNG, or PDF.';
                    } else if (formData.idFile.size > maxSize) {
                        newErrors.idFile = 'File size must be under 5MB.';
                    }
                }
                
                // Emergency Contact (Optional fields validation)
                if (formData.emergencyContactEmail && !/\S+@\S+\.\S+/.test(formData.emergencyContactEmail)) {
                    newErrors.emergencyContactEmail = 'Please enter a valid email address.';
                }
                if (formData.emergencyContactPhone && !/^\+91\d{10}$/.test(formData.emergencyContactPhone)) {
                    newErrors.emergencyContactPhone = 'Must be a 10-digit number starting with +91.';
                }

                // Terms
                if (!formData.termsAgreed) newErrors.termsAgreed = 'You must agree to the terms.';

                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            // --- RENDER LOGIC ---

            const renderError = (field) => errors[field] && (
                <p className="text-sm text-red-600 flex items-center gap-1 mt-1">
                    <AlertCircle className="h-4 w-4" /> {errors[field]}
                </p>
            );

            const renderStep = () => {
                switch (currentStep) {
                    case STEPS.BOOKING_ID:
                        return (
                            <Card className="shadow-2xl animate-fade-in">
                                <CardHeader>
                                    <CardTitle className="text-2xl font-bold">Welcome! Let's Get Started</CardTitle>
                                    <CardDescription>Enter your booking ID to retrieve your reservation details.</CardDescription>
                                </CardHeader>
                                <form onSubmit={handleBookingIdSubmit}>
                                    <CardContent className="space-y-4">
                                        <div className="space-y-2">
                                            <Label htmlFor="bookingId" className="text-base">Booking ID</Label>
                                            <Input
                                                id="bookingId"
                                                type="text"
                                                value={bookingId}
                                                onChange={(e) => {
                                                    setBookingId(e.target.value);
                                                    if (errors.bookingId) setErrors({});
                                                }}
                                                placeholder="e.g., BK12345"
                                                className={`text-lg p-4 ${errors.bookingId ? 'border-red-500' : ''}`}
                                            />
                                            {renderError('bookingId')}
                                        </div>
                                    </CardContent>
                                    <CardFooter>
                                        <Button type="submit" className="w-full text-lg py-6" disabled={isLoading}>
                                            {isLoading ? <><Loader2 className="mr-2 h-5 w-5 animate-spin" /> Fetching Details...</> : 'Continue'}
                                        </Button>
                                    </CardFooter>
                                </form>
                            </Card>
                        );

                    case STEPS.FORM_FILL:
                        return (
                            <Card className="shadow-2xl animate-fade-in">
                                <CardHeader className="text-center bg-gradient-to-r from-gray-800 to-gray-900 text-white rounded-t-lg p-6">
                                    <CardTitle className="text-3xl font-bold">Guest Check-In Form</CardTitle>
                                    <CardDescription className="text-gray-300">
                                        Welcome, {formData.guestName}. Please complete the details below.
                                    </CardDescription>
                                </CardHeader>
                                <form onSubmit={handleFormSubmit}>
                                    <CardContent className="p-8 space-y-8">
                                        {errors.submit && (
                                            <Alert variant="destructive">
                                                <AlertCircle className="h-4 w-4" />
                                                <AlertTitle>Submission Error</AlertTitle>
                                                <AlertDescription>{errors.submit}</AlertDescription>
                                            </Alert>
                                        )}

                                        {/* Booking Details Section */}
                                        <div className="grid md:grid-cols-2 gap-6 border-b pb-6">
                                            <div className="space-y-2">
                                                <Label htmlFor="checkInDate">Check-In Date *</Label>
                                                <Input id="checkInDate" type="date" value={formData.checkInDate} onChange={(e) => handleInputChange('checkInDate', e.target.value)} className={errors.checkInDate ? 'border-red-500' : ''} />
                                                {renderError('checkInDate')}
                                            </div>
                                            <div className="space-y-2">
                                                <Label htmlFor="checkOutDate">Estimated Check-Out Date *</Label>
                                                <Input id="checkOutDate" type="date" value={formData.checkOutDate} onChange={(e) => handleInputChange('checkOutDate', e.target.value)} className={errors.checkOutDate ? 'border-red-500' : ''} />
                                                {renderError('checkOutDate')}
                                            </div>
                                        </div>

                                        {/* Guest Information Section */}
                                        <div className="space-y-6 border-b pb-6">
                                            <h3 className="text-lg font-semibold text-gray-700">Guest Information</h3>
                                            <div className="grid md:grid-cols-2 gap-6">
                                                <div className="space-y-2">
                                                    <Label htmlFor="numberOfGuests">Number of Guests *</Label>
                                                    <Input id="numberOfGuests" type="number" min="1" max="10" value={formData.numberOfGuests} onChange={(e) => handleInputChange('numberOfGuests', e.target.value)} className={errors.numberOfGuests ? 'border-red-500' : ''} placeholder="1-10"/>
                                                    {renderError('numberOfGuests')}
                                                </div>
                                                {parseInt(formData.numberOfGuests) > 1 && (
                                                    <div className="space-y-2 animate-fade-in">
                                                        <Label htmlFor="relationshipWithGuests">Relationship with other guests? *</Label>
                                                        <Select value={formData.relationshipWithGuests} onValueChange={(value) => handleInputChange('relationshipWithGuests', value)}>
                                                            <SelectTrigger className={errors.relationshipWithGuests ? 'border-red-500' : ''}><SelectValue placeholder="Select relationship" /></SelectTrigger>
                                                            <SelectContent>
                                                                {RELATIONSHIP_OPTIONS.map(opt => <SelectItem key={opt.value} value={opt.value}>{opt.label}</SelectItem>)}
                                                            </SelectContent>
                                                        </Select>
                                                        {renderError('relationshipWithGuests')}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        
                                        {/* Address Section */}
                                        <div className="space-y-6 border-b pb-6">
                                            <h3 className="text-lg font-semibold text-gray-700">Address Details</h3>
                                            <div className="grid md:grid-cols-2 gap-6">
                                                <div className="space-y-2">
                                                    <Label htmlFor="city">City / Locality *</Label>
                                                    <Input id="city" value={formData.city} onChange={e => handleInputChange('city', e.target.value)} className={errors.city ? 'border-red-500' : ''} placeholder="e.g., Guwahati" />
                                                    {renderError('city')}
                                                </div>
                                                <div className="space-y-2">
                                                    <Label htmlFor="nationality">Nationality *</Label>
                                                    <Input id="nationality" value={formData.nationality} onChange={e => handleInputChange('nationality', e.target.value)} className={errors.nationality ? 'border-red-500' : ''} placeholder="e.g., Indian" />
                                                    {renderError('nationality')}
                                                </div>
                                                <div className="space-y-2">
                                                    <Label htmlFor="state">State *</Label>
                                                    <Input id="state" value={formData.state} onChange={e => handleInputChange('state', e.target.value)} className={errors.state ? 'border-red-500' : ''} placeholder="e.g., Assam" />
                                                    {renderError('state')}
                                                </div>
                                                <div className="space-y-2">
                                                    <Label htmlFor="zipCode">Zip Code *</Label>
                                                    <Input id="zipCode" value={formData.zipCode} onChange={e => handleInputChange('zipCode', e.target.value)} className={errors.zipCode ? 'border-red-500' : ''} placeholder="e.g., 781001" />
                                                    {renderError('zipCode')}
                                                </div>
                                            </div>
                                        </div>

                                        {/* ID Section */}
                                        <div className="space-y-6 border-b pb-6">
                                            <h3 className="text-lg font-semibold text-gray-700">Identification</h3>
                                            <div className="grid md:grid-cols-2 gap-6">
                                                <div className="space-y-2">
                                                    <Label htmlFor="idCardType">ID Card Type *</Label>
                                                    <Select value={formData.idCardType} onValueChange={(value) => handleInputChange('idCardType', value)}>
                                                        <SelectTrigger className={errors.idCardType ? 'border-red-500' : ''}><SelectValue placeholder="Select ID type" /></SelectTrigger>
                                                        <SelectContent>
                                                            {ID_CARD_TYPES.map(type => <SelectItem key={type.value} value={type.value}>{type.label}</SelectItem>)}
                                                        </SelectContent>
                                                    </Select>
                                                    {renderError('idCardType')}
                                                </div>
                                                {formData.idCardType === 'other' && (
                                                    <div className="space-y-2 animate-fade-in">
                                                        <Label htmlFor="idCardTypeOther">Please specify *</Label>
                                                        <Input id="idCardTypeOther" value={formData.idCardTypeOther} onChange={e => handleInputChange('idCardTypeOther', e.target.value)} className={errors.idCardTypeOther ? 'border-red-500' : ''} placeholder="Enter ID card type" />
                                                        {renderError('idCardTypeOther')}
                                                    </div>
                                                )}
                                            </div>
                                            <div className="space-y-2">
                                                <Label htmlFor="idFile">Upload ID Document * <span className="text-xs text-gray-500">(JPG, PNG, PDF | Max 5MB)</span></Label>
                                                <Input id="idFile" type="file" accept=".jpg,.jpeg,.png,.pdf" onChange={handleFileChange} className={`${errors.idFile ? 'border-red-500' : ''} file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-50 file:text-gray-700 hover:file:bg-gray-100`} />
                                                {formData.idFile && <p className="text-sm text-green-600 mt-1">File selected: {formData.idFile.name}</p>}
                                                {renderError('idFile')}
                                            </div>
                                        </div>
                                        
                                        {/* Emergency Contact Section */}
                                        <div className="space-y-6">
                                            <h3 className="text-lg font-semibold text-gray-700">Emergency Contact (Optional)</h3>
                                            <div className="grid md:grid-cols-2 gap-6">
                                                <div className="space-y-2">
                                                    <Label htmlFor="emergencyContactName">Contact Name</Label>
                                                    <Input id="emergencyContactName" value={formData.emergencyContactName} onChange={e => handleInputChange('emergencyContactName', e.target.value)} placeholder="Full Name" />
                                                </div>
                                                <div className="space-y-2">
                                                    <Label htmlFor="emergencyContactEmail">Email Address</Label>
                                                    <Input id="emergencyContactEmail" type="email" value={formData.emergencyContactEmail} onChange={e => handleInputChange('emergencyContactEmail', e.target.value)} className={errors.emergencyContactEmail ? 'border-red-500' : ''} placeholder="example@mail.com" />
                                                    {renderError('emergencyContactEmail')}
                                                </div>
                                                <div className="space-y-2 md:col-span-2">
                                                    <Label htmlFor="emergencyContactPhone">Contact Number</Label>
                                                    <div className="relative">
                                                        <span className="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">+91</span>
                                                        <Input id="emergencyContactPhone" type="tel" value={formData.emergencyContactPhone.replace('+91', '')} onChange={e => handleInputChange('emergencyContactPhone', `+91${e.target.value.replace(/\D/g, '').slice(0, 10)}`)} className={`${errors.emergencyContactPhone ? 'border-red-500' : ''} pl-12`} placeholder="9876543210" />
                                                    </div>
                                                    {renderError('emergencyContactPhone')}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Terms and Conditions */}
                                        <div className="flex items-start space-x-3 pt-6 border-t">
                                            <Checkbox id="termsAgreed" checked={formData.termsAgreed} onCheckedChange={(checked) => handleInputChange('termsAgreed', checked)} className={errors.termsAgreed ? 'border-red-500' : ''} />
                                            <div className="grid gap-1.5 leading-none">
                                                <Label htmlFor="termsAgreed">I agree to the <Dialog><DialogTrigger asChild><button type="button" className="text-blue-600 hover:underline">Terms and Conditions</button></DialogTrigger><DialogContent><DialogHeader><DialogTitle>Terms & Conditions</DialogTitle></DialogHeader><p>Detailed terms and conditions content goes here...</p></DialogContent></Dialog> *</Label>
                                                {renderError('termsAgreed')}
                                            </div>
                                        </div>

                                    </CardContent>
                                    <CardFooter className="flex justify-end p-6 bg-gray-50 rounded-b-lg">
                                        <Button type="submit" className="text-lg py-3 px-8">Review & Confirm</Button>
                                    </CardFooter>
                                </form>
                            </Card>
                        );

                    case STEPS.CONFIRMATION:
                        return (
                            <Card className="shadow-2xl animate-fade-in">
                                <CardHeader>
                                    <CardTitle className="text-2xl font-bold">Confirm Your Details</CardTitle>
                                    <CardDescription>Please review all information carefully before final submission.</CardDescription>
                                </CardHeader>
                                <CardContent className="space-y-6 text-sm">
                                    <div className="p-4 bg-gray-50 rounded-lg space-y-4">
                                        <h3 className="font-semibold text-lg border-b pb-2">Booking & Guest Details</h3>
                                        <p><strong>Guest Name:</strong> {formData.guestName}</p>
                                        <p><strong>Check-in:</strong> {formData.checkInDate}</p>
                                        <p><strong>Check-out:</strong> {formData.checkOutDate}</p>
                                        <p><strong>Number of Guests:</strong> {formData.numberOfGuests}</p>
                                        {parseInt(formData.numberOfGuests) > 1 && <p><strong>Relationship:</strong> {formData.relationshipWithGuests}</p>}
                                    </div>
                                    <div className="p-4 bg-gray-50 rounded-lg space-y-4">
                                        <h3 className="font-semibold text-lg border-b pb-2">Address</h3>
                                        <p><strong>City/Locality:</strong> {formData.city}</p>
                                        <p><strong>State:</strong> {formData.state}</p>
                                        <p><strong>Zip Code:</strong> {formData.zipCode}</p>
                                        <p><strong>Nationality:</strong> {formData.nationality}</p>
                                    </div>
                                    <div className="p-4 bg-gray-50 rounded-lg space-y-4">
                                        <h3 className="font-semibold text-lg border-b pb-2">Identification</h3>
                                        <p><strong>ID Type:</strong> {formData.idCardType === 'other' ? formData.idCardTypeOther : ID_CARD_TYPES.find(t => t.value === formData.idCardType)?.label || formData.idCardType}</p>
                                        <p><strong>ID Document:</strong> {formData.idFile?.name || 'N/A'}</p>
                                    </div>
                                    {formData.emergencyContactName && (
                                        <div className="p-4 bg-gray-50 rounded-lg space-y-4">
                                            <h3 className="font-semibold text-lg border-b pb-2">Emergency Contact</h3>
                                            <p><strong>Name:</strong> {formData.emergencyContactName}</p>
                                            {formData.emergencyContactEmail && <p><strong>Email:</strong> {formData.emergencyContactEmail}</p>}
                                            {formData.emergencyContactPhone && <p><strong>Phone:</strong> {formData.emergencyContactPhone}</p>}
                                        </div>
                                    )}
                                </CardContent>
                                <CardFooter className="flex justify-between p-6 bg-gray-50 rounded-b-lg">
                                <Button variant="outline" onClick={() => setCurrentStep(STEPS.FORM_FILL)} disabled={isSubmitting} className="bg-white text-gray-700 border-gray-300 hover:bg-gray-100">Go Back & Edit</Button>
                                <Button onClick={handleFinalSubmit} className="text-lg py-3 px-8" disabled={isSubmitting}>
                                    {isSubmitting ? <><Loader2 className="mr-2 h-5 w-5 animate-spin" /> Submitting...</> : 'Confirm Check-In'}
                                </Button>
                                </CardFooter>
                            </Card>
                        );

                    case STEPS.SUCCESS:
                        return (
                            <Card className="shadow-2xl animate-fade-in text-center p-8">
                                <CardContent className="flex flex-col items-center justify-center space-y-4">
                                    <CheckCircle className="h-20 w-20 text-green-500" />
                                    <h2 className="text-3xl font-bold">Check-In Complete!</h2>
                                    <p className="text-gray-600 max-w-md">
                                        Thank you, {formData.guestName}. Your details have been recorded. You will receive a confirmation shortly. The room is now marked as occupied until {formData.checkOutDate}.
                                    </p>
                                    <Button onClick={resetForm} className="mt-6">Start New Check-In</Button>
                                </CardContent>
                            </Card>
                        );
                    default:
                        return <div>Error: Invalid step.</div>;
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-gray-50 to-gray-200 flex items-center justify-center py-12 px-4">
                    <div className="max-w-2xl w-full mx-auto">
                        {renderStep()}
                    </div>
                </div>
            );
        }

        // Render the React App component into the root div
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
