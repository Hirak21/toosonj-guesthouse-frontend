<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice & Finalization - Toosonj Guest House</title>
    <!-- Google Fonts: Inter for modern typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <style>
        /* Base font and background color */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Lighter background for a modern feel */
            color: #333; /* Default text color */
        }
        /* Main container for the invoice, centered and with max-width */
        .invoice-container {
            max-width: 900px; /* Slightly wider for better content display */
            margin: 40px auto;
            padding: 15px; /* Add some padding for smaller screens */
        }
        /* Styling for the main invoice box */
        .invoice-box {
            background: white;
            padding: 2rem 3rem; /* Adjusted padding */
            border-radius: 15px; /* More pronounced rounded corners */
            box-shadow: 0 15px 50px rgba(0,0,0,0.15); /* Stronger, softer shadow */
            transition: all 0.3s ease-in-out; /* Smooth transitions for any dynamic changes */
        }
        /* Spinner for loading state */
        .spinner {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #d4af37; /* Gold color for the spinner */
            border-radius: 50%;
            width: 50px; /* Slightly larger spinner */
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 2rem auto 1.5rem;
        }
        /* Keyframe animation for the spinner */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Print styles to hide non-invoice elements and format for printing */
        @media print {
            body * {
                visibility: hidden; /* Hide everything by default */
            }
            .invoice-box, .invoice-box * {
                visibility: visible; /* Make invoice content visible */
            }
            .invoice-box {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 1rem;
                border: none;
                box-shadow: none;
                border-radius: 0; /* No rounded corners in print */
            }
            .no-print {
                display: none; /* Hide elements not needed in print */
            }
        }
        /* Custom button styling for a more modern look */
        .btn-primary {
            background: linear-gradient(to right, #4a90e2, #6a5acd); /* Blue to purple gradient */
            color: white;
            font-weight: 600;
            padding: 14px 30px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-success {
            background: linear-gradient(to right, #28a745, #218838); /* Green gradient */
            color: white;
            font-weight: 600;
            padding: 14px 30px;
            border-radius: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: none;
            cursor: pointer;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        .btn-add {
            background-color: #0d6efd; /* Bootstrap primary blue */
            color: white;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        .btn-add:hover {
            background-color: #0a58ca;
        }
    </style>
</head>
<body>
    <div class="invoice-container">
        <!-- Loading State -->
        <div id="loading-container" class="text-center p-8 bg-white rounded-xl shadow-lg">
            <div class="spinner"></div>
            <p class="text-xl font-semibold text-gray-700">Loading Booking & Services...</p>
            <p class="text-gray-500 mt-2">Please wait while we retrieve the details.</p>
        </div>

        <!-- Error State -->
        <div id="error-container" class="text-center p-8 bg-white rounded-xl shadow-lg hidden">
             <i class="fas fa-exclamation-triangle text-7xl text-red-500 mb-6 animate-bounce"></i>
             <h3 class="text-3xl font-bold text-gray-800 mb-3">Oops! Something went wrong.</h3>
             <p id="error-message" class="text-gray-600 text-lg mt-2"></p>
             <button onclick="window.location.reload()" class="mt-8 btn-primary">
                 <i class="fas fa-redo-alt mr-2"></i> Try Again
             </button>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <div class="invoice-box" id="invoice-to-print">
                <!-- Invoice Header -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 pb-4 border-b border-gray-200">
                    <div class="mb-6 md:mb-0">
                        <h1 class="text-4xl font-extrabold text-gray-900 leading-tight">Toosonj Guest House</h1>
                        <p class="text-gray-600 mt-1 text-md">Kinaram Mikir Path, VIP Road, Guwahati, Assam</p>
                        <p class="text-gray-600 text-md">GSTIN: <span id="guest-house-gstin" class="font-semibold text-gray-700">22AAAAA0000A1Z5</span></p>
                    </div>
                    <div class="text-left md:text-right">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">TAX INVOICE</h2>
                        <p class="text-gray-600 text-md">Invoice #: <span id="invoice-number" class="font-semibold text-gray-700"></span></p>
                        <p class="text-gray-600 text-md">Date: <span id="invoice-date" class="font-semibold text-gray-700"></span></p>
                    </div>
                </div>

                <!-- Guest Details -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10 border-t border-b border-gray-200 py-6">
                    <div>
                        <h3 class="font-bold text-lg text-gray-700 mb-2">Bill To:</h3>
                        <p id="guest-name" class="text-gray-800 font-medium"></p>
                        <p id="guest-address" class="text-gray-600"></p>
                        <p id="guest-email" class="text-gray-600"></p>
                        <p id="guest-phone" class="text-gray-600"></p>
                    </div>
                    <div class="text-left md:text-right mt-4 md:mt-0">
                        <p class="text-gray-600 text-md mb-1">Booking ID: <span id="booking-id" class="font-bold text-gray-800"></span></p>
                        <p class="text-gray-600 text-md mb-1">Check-in: <span id="checkin-date" class="font-bold text-gray-800"></span></p>
                        <p class="text-gray-600 text-md">Check-out: <span id="checkout-date" class="font-bold text-gray-800"></span></p>
                    </div>
                </div>

                <!-- Invoice Items Table -->
                <div class="overflow-x-auto mb-10">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-gray-100 border-b border-gray-200">
                                <th class="p-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Item Description</th>
                                <th class="p-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">HSN/SAC</th>
                                <th class="p-4 text-right text-sm font-semibold text-gray-700 uppercase tracking-wider">Quantity</th>
                                <th class="p-4 text-right text-sm font-semibold text-gray-700 uppercase tracking-wider">Rate</th>
                                <th class="p-4 text-right text-sm font-semibold text-gray-700 uppercase tracking-wider">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items" class="divide-y divide-gray-100">
                            <!-- Items will be injected here -->
                        </tbody>
                    </table>
                </div>

                <!-- Add Extra Services Section -->
                <div class="mb-10 p-6 bg-blue-50 rounded-xl shadow-inner no-print">
                    <h3 class="font-bold text-xl text-blue-800 mb-4 flex items-center">
                        <i class="fas fa-plus-circle mr-3 text-blue-600"></i> Add Extra Services
                    </h3>
                    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
                        <select id="service-select" class="flex-grow p-3 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300 text-gray-700">
                            <!-- Services will be populated here -->
                        </select>
                        <input type="number" id="service-quantity" value="1" min="1" class="w-full sm:w-24 p-3 border border-blue-200 rounded-lg text-center focus:ring-2 focus:ring-blue-300 focus:border-blue-300 text-gray-700">
                        <button onclick="addServiceToInvoice()" class="btn-add w-full sm:w-auto">
                            <i class="fas fa-cart-plus mr-2"></i> Add Service
                        </button>
                    </div>
                </div>

                <!-- Totals Section -->
                <div class="flex justify-end">
                    <div class="w-full md:w-2/3 lg:w-1/2">
                        <div class="flex justify-between py-3 border-b border-gray-200">
                            <span class="font-semibold text-gray-700 text-lg">Subtotal</span>
                            <span id="subtotal" class="font-bold text-gray-900 text-lg"></span>
                        </div>
                        <div id="gst-details" class="border-b border-gray-200 pb-2">
                           <!-- GST rows will be injected here -->
                        </div>
                        <div class="flex justify-between py-4 font-extrabold text-2xl border-t-2 border-gray-800 mt-4">
                            <span>TOTAL AMOUNT</span>
                            <span id="grand-total" class="text-green-700"></span>
                        </div>
                         <div class="flex justify-between py-2 text-gray-700 text-lg">
                            <span>Advance Paid</span>
                            <span id="advance-paid" class="font-semibold text-gray-800"></span>
                        </div>
                         <div class="flex justify-between py-3 font-extrabold text-2xl text-red-600 border-t border-gray-200 mt-2">
                            <span>BALANCE DUE</span>
                            <span id="balance-due"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="text-center mt-10 no-print">
                <button onclick="generatePDF()" class="btn-success">
                    <i class="fas fa-file-pdf mr-3"></i> Download / Print Invoice
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL STATE & CONFIG ---
        let currentBooking = null; // Stores the fetched booking details
        let availableServices = []; // Stores the list of services available
        let invoiceItems = []; // Array to hold all items on the invoice (rooms + services)
        const GUEST_HOUSE_STATE = "Assam"; // Your business state for GST calculation (important for IGST/CGST+SGST)
        const GST_RATES = { cgst: 9, sgst: 9, igst: 18 }; // Standard GST rates

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Get the 'token' from the URL query parameters
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            // If no token is provided, show an error message
            if (!token) {
                showError("No booking token provided. Please ensure you are using the correct link from your confirmation email.");
                return;
            }
            
            // In a real production application, these would be separate asynchronous API calls
            // to your backend server to fetch data from a database.
            // We are mocking them here with a delay to simulate network latency.
            const bookingPromise = mockFetchBooking(token);
            const servicesPromise = mockFetchServices();

            try {
                // Wait for both booking and services data to be fetched concurrently
                [currentBooking, availableServices] = await Promise.all([bookingPromise, servicesPromise]);
                
                // Populate the dropdown for adding new services
                populateServiceDropdown();
                // Initialize the invoice with booking details and calculate totals
                initializeInvoice();
                // Hide loading and show the main content
                showMainContent();
            } catch (error) {
                // Catch any errors during data fetching and display them
                showError(`Failed to load data: ${error.message}. Please try again later.`);
            }
        });

        // --- MOCK API CALLS (***REPLACE THESE WITH REAL FETCH CALLS TO YOUR BACKEND***) ---
        /**
         * Mocks fetching booking details from a backend.
         * In a real application, this would be a `fetch` call to your API endpoint.
         * @param {string} token - The booking token to identify the booking.
         * @returns {Promise<Object>} - A promise that resolves with mock booking data.
         */
        async function mockFetchBooking(token) {
            console.log(`Simulating fetching booking with token: ${token}`);
            // Simulate network delay
            await new Promise(r => setTimeout(r, 1500)); // Increased delay for better loading visualization
            
            // This is static mock data. In a real scenario, your backend would query a database
            // (e.g., Firestore, PostgreSQL, MongoDB) using the token to retrieve actual booking information.
            return {
                bookingId: `TGH-${token.slice(0, 6).toUpperCase()}`, // Example: TGH-ABCDEF
                checkin: "2025-08-10",
                checkout: "2025-08-12",
                duration: 2, // Calculated from checkin/checkout dates in a real system
                guest: {
                    name: "Aarav Sharma",
                    email: "aarav.sharma@example.com",
                    phone: "+91 98765 43210",
                    address: "123, MG Road, Bandra",
                    city: "Mumbai",
                    state: "Maharashtra", // Crucial for GST calculation
                    pincode: "400050"
                },
                rooms: {
                    deluxe: { quantity: 1, price: 1499 }, // Price per night
                    standard: { quantity: 0, price: 1099 }
                },
                payment: {
                    amountPaid: 699 // Advance paid by the guest
                }
            };
        }

        /**
         * Mocks fetching available services from a backend.
         * In a real application, this would be a `fetch` call to your API endpoint.
         * @returns {Promise<Array<Object>>} - A promise that resolves with mock services data.
         */
        async function mockFetchServices() {
            console.log("Simulating fetching available services...");
            // Simulate network delay
            await new Promise(r => setTimeout(r, 800));
            
            // This is static mock data. In a real scenario, your backend would fetch this
            // from a services catalog in your database.
            return [
                { id: 1, name: 'Laundry Service (Per Load)', charge: 250, sac: '998511' },
                { id: 2, name: 'Extra Meal (Lunch/Dinner)', charge: 350, sac: '996331' },
                { id: 3, name: 'Airport Transfer (One Way)', charge: 800, sac: '996411' },
                { id: 4, name: 'Local Sightseeing Tour', charge: 1200, sac: '998599' },
                { id: 5, name: 'Late Check-out (Per Hour)', charge: 150, sac: '996311' }
            ];
        }

        // --- INVOICE LOGIC ---
        /**
         * Initializes the invoice by populating header details, guest information,
         * and adding room charges as the initial invoice items.
         */
        function initializeInvoice() {
            // Populate static header and guest details from the fetched booking
            document.getElementById('invoice-number').textContent = `INV-${currentBooking.bookingId}`;
            document.getElementById('invoice-date').textContent = new Date().toLocaleDateString('en-GB'); // Format: DD/MM/YYYY
            document.getElementById('guest-name').textContent = currentBooking.guest.name;
            document.getElementById('guest-address').textContent = `${currentBooking.guest.address}, ${currentBooking.guest.city}, ${currentBooking.guest.pincode}`;
            document.getElementById('guest-email').textContent = currentBooking.guest.email;
            document.getElementById('guest-phone').textContent = currentBooking.guest.phone;
            document.getElementById('booking-id').textContent = currentBooking.bookingId;
            document.getElementById('checkin-date').textContent = new Date(currentBooking.checkin).toLocaleDateString('en-GB');
            document.getElementById('checkout-date').textContent = new Date(currentBooking.checkout).toLocaleDateString('en-GB');

            // Add room charges as the initial items to the invoiceItems array
            for (const type in currentBooking.rooms) {
                const room = currentBooking.rooms[type];
                if (room.quantity > 0) {
                    invoiceItems.push({
                        description: `${room.quantity > 1 ? room.quantity + ' x ' : ''}${type.charAt(0).toUpperCase() + type.slice(1)} Room Stay`,
                        hsnSac: '996311', // HSN/SAC code for Accommodation services
                        quantity: currentBooking.duration, // Number of nights
                        rate: room.price * room.quantity, // Total rate for all rooms of this type per night
                        isService: false // Flag to differentiate room charges from other services
                    });
                }
            }
            // Recalculate and render all invoice details
            calculateAndRender();
        }

        /**
         * Adds a selected service to the invoice items list and re-renders the invoice.
         */
        function addServiceToInvoice() {
            const serviceId = document.getElementById('service-select').value;
            const quantityInput = document.getElementById('service-quantity');
            const quantity = parseInt(quantityInput.value);

            // Basic validation
            if (!serviceId || isNaN(quantity) || quantity < 1) {
                alert("Please select a service and enter a valid quantity."); // Using alert for simplicity, but a custom modal is better
                return;
            }

            const service = availableServices.find(s => s.id == serviceId);
            if (service) {
                invoiceItems.push({
                    description: service.name,
                    hsnSac: service.sac,
                    quantity: quantity,
                    rate: service.charge,
                    isService: true
                });
                // Reset quantity input after adding
                quantityInput.value = 1;
                // Recalculate and render the invoice
                calculateAndRender();
            } else {
                alert("Selected service not found."); // Using alert for simplicity
            }
        }

        /**
         * Calculates all totals (subtotal, GST, grand total, balance due)
         * and renders them in the invoice table and summary sections.
         */
        function calculateAndRender() {
            let subtotal = 0;
            const itemsTbody = document.getElementById('invoice-items');
            itemsTbody.innerHTML = ''; // Clear previous items

            // Iterate through invoice items, calculate amounts, and render table rows
            invoiceItems.forEach(item => {
                const amount = item.rate * item.quantity;
                subtotal += amount; // Accumulate subtotal
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 text-gray-800">${item.description}</td>
                        <td class="p-4 text-gray-600">${item.hsnSac}</td>
                        <td class="p-4 text-right text-gray-800">${item.quantity} ${item.isService ? 'unit(s)' : 'night(s)'}</td>
                        <td class="p-4 text-right text-gray-800">₹${item.rate.toFixed(2)}</td>
                        <td class="p-4 text-right font-semibold text-gray-900">₹${amount.toFixed(2)}</td>
                    </tr>
                `;
                itemsTbody.innerHTML += row;
            });

            document.getElementById('subtotal').textContent = `₹${subtotal.toFixed(2)}`;

            // GST Calculation Logic based on guest's state vs. guest house state
            const gstDetailsDiv = document.getElementById('gst-details');
            let totalGST = 0;
            gstDetailsDiv.innerHTML = ''; // Clear previous GST details

            // Check if guest's state is the same as the guest house's state (Intra-state supply)
            if (currentBooking.guest.state.toLowerCase() === GUEST_HOUSE_STATE.toLowerCase()) {
                const cgst = subtotal * (GST_RATES.cgst / 100);
                const sgst = subtotal * (GST_RATES.sgst / 100);
                totalGST = cgst + sgst;
                gstDetailsDiv.innerHTML = `
                    <div class="flex justify-between py-2 text-gray-600"><span class="font-medium">CGST @ ${GST_RATES.cgst}%</span><span>₹${cgst.toFixed(2)}</span></div>
                    <div class="flex justify-between py-2 text-gray-600"><span class="font-medium">SGST @ ${GST_RATES.sgst}%</span><span>₹${sgst.toFixed(2)}</span></div>
                `;
            } else {
                // Inter-state supply
                const igst = subtotal * (GST_RATES.igst / 100);
                totalGST = igst;
                gstDetailsDiv.innerHTML = `<div class="flex justify-between py-2 text-gray-600"><span class="font-medium">IGST @ ${GST_RATES.igst}%</span><span>₹${igst.toFixed(2)}</span></div>`;
            }

            const grandTotal = subtotal + totalGST;
            const advancePaid = currentBooking.payment.amountPaid;
            const balanceDue = grandTotal - advancePaid;

            // Update final total summary
            document.getElementById('grand-total').textContent = `₹${grandTotal.toFixed(2)}`;
            document.getElementById('advance-paid').textContent = `- ₹${advancePaid.toFixed(2)}`;
            // Apply color based on balance due (green for positive, red for negative/due)
            const balanceDueElement = document.getElementById('balance-due');
            balanceDueElement.textContent = `₹${balanceDue.toFixed(2)}`;
            balanceDueElement.classList.remove('text-green-600', 'text-red-600'); // Clear previous classes
            if (balanceDue >= 0) {
                balanceDueElement.classList.add('text-red-600'); // Still due, or zero
            } else {
                balanceDueElement.classList.add('text-green-600'); // Overpaid or credit
            }
        }

        /**
         * Generates a PDF of the invoice content using html2pdf.js.
         */
        function generatePDF() {
            const element = document.getElementById('invoice-to-print');
            const opt = {
                margin:       0.5, // Margin around the PDF content
                filename:     `Invoice-${currentBooking.bookingId}.pdf`, // Dynamic filename
                image:        { type: 'jpeg', quality: 0.98 }, // Image quality for canvas rendering
                html2canvas:  { scale: 2, logging: false, useCORS: true }, // Scale for better resolution, disable logging
                jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' } // PDF format and orientation
            };
            // Use html2pdf to generate and save the PDF
            html2pdf().from(element).set(opt).save();
        }

        // --- UI HELPER FUNCTIONS ---
        /**
         * Populates the service selection dropdown with available services.
         */
        function populateServiceDropdown() {
            const select = document.getElementById('service-select');
            select.innerHTML = '<option value="">Select a service...</option>'; // Default option
            availableServices.forEach(s => {
                select.innerHTML += `<option value="${s.id}">${s.name} (₹${s.charge.toFixed(2)})</option>`;
            });
        }
        
        /**
         * Displays the error container and hides loading/main content.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            document.getElementById('loading-container').classList.add('hidden');
            document.getElementById('main-content').classList.add('hidden');
            const errorContainer = document.getElementById('error-container');
            document.getElementById('error-message').textContent = message;
            errorContainer.classList.remove('hidden');
        }

        /**
         * Hides the loading and error containers and displays the main content.
         */
        function showMainContent() {
            document.getElementById('loading-container').classList.add('hidden');
            document.getElementById('error-container').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
        }
    </script>
</body>
</html>